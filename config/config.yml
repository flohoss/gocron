defaults:
  cron: '0 3 * * *'
  envs:
    - key: RESTIC_PASSWORD_FILE
      value: '/secrets/.resticpwd'

jobs:
  - name: Directus
    envs:
      - key: RESTIC_REPOSITORY
        value: rclone:pcloud:Server/Backups/directus
    commands:
      - command: restic backup /mnt/user/appdata/directus
  - name: Forgejo
    envs:
      - key: RESTIC_REPOSITORY
        value: rclone:pcloud:Server/Backups/forgejo
    commands:
      - command: docker exec -e PASSWORD=password forgejo-db pg_dump db --username=user
        file_output: /mnt/user/appdata/forgejo/.dbBackup.sql
      - command: restic backup /mnt/user/appdata/forgejo
  - name: Nextcloud
    commands:
      - command: rclone sync --multi-thread-streams=1 /mnt/user/nextcloud-backup pcloud:Server/Backups/nextcloud-aio
  - name: Cleanup
    cron: '0 5 * * 0'
    envs:
      - key: RESTIC_POLICY
        value: '--keep-daily 7 --keep-weekly 5 --keep-monthly 12 --keep-yearly 75'
    commands:
      - command: restic -r rclone:pcloud:Server/Backups/directus unlock
      - command: restic -r rclone:pcloud:Server/Backups/directus forget $RESTIC_POLICY --prune
      - command: restic -r rclone:pcloud:Server/Backups/forgejo unlock
      - command: restic -r rclone:pcloud:Server/Backups/forgejo forget $RESTIC_POLICY --prune
